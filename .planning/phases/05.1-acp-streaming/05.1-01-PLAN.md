---
phase: 05.1-acp-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/server.ts
  - src/mcp/tools/cron.ts
  - src/mcp/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "MCP server exposes create_cron, list_crons, delete_cron tools"
    - "Tools accept typed parameters (not CLI string construction)"
    - "Tools call existing cron service functions"
  artifacts:
    - path: "src/mcp/tools/cron.ts"
      provides: "Cron tool definitions with Zod schemas"
      exports: ["createCronTool", "listCronsTool", "deleteCronTool"]
    - path: "src/mcp/server.ts"
      provides: "In-process MCP server via createSdkMcpServer"
      exports: ["klausbotMcp"]
    - path: "src/mcp/index.ts"
      provides: "Public exports for MCP module"
      exports: ["klausbotMcp"]
  key_links:
    - from: "src/mcp/tools/cron.ts"
      to: "src/cron/service.ts"
      via: "import { createCronJob, listCronJobs, deleteCronJob }"
      pattern: "import.*from.*cron/service"
    - from: "src/mcp/server.ts"
      to: "src/mcp/tools/cron.ts"
      via: "tools array in createSdkMcpServer"
      pattern: "tools:\\s*\\["
---

<objective>
Create in-process MCP server with cron tools using Claude Agent SDK.

Purpose: Enable Claude to manage cron jobs via typed MCP tool calls instead of CLI string construction.
Output: `src/mcp/` module with klausbotMcp server exporting cron management tools.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-acp-streaming/05.1-RESEARCH.md
@src/cron/service.ts
@src/cron/types.ts
@src/cron/parse.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Claude Agent SDK and create cron tools</name>
  <files>
    - package.json
    - src/mcp/tools/cron.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install @anthropic-ai/claude-agent-sdk @modelcontextprotocol/sdk
   ```
   Note: zod already in package.json

2. Create `src/mcp/tools/cron.ts` with three tools using `tool()` from claude-agent-sdk:

   **create_cron tool:**
   - Parameters (Zod schema):
     - name: z.string().describe("Human-readable job name")
     - schedule: z.string().describe("Schedule: cron expression, natural language (e.g., 'every day at 9am'), or interval (e.g., 'every 5 minutes')")
     - instruction: z.string().describe("What Claude should do when job runs")
     - chatId: z.number().describe("Telegram chat ID for notifications")
   - Implementation:
     - Import { parseSchedule, ParsedSchedule } from '../cron/parse.js'
     - Import { createCronJob, CreateCronJobParams } from '../cron/service.js'
     - Call parseSchedule(schedule) to get ParsedSchedule | null
     - If null: return error message "Could not parse schedule: {schedule}"
     - Extract .schedule and .humanReadable from ParsedSchedule
     - Call createCronJob with: { name, schedule: parsed.schedule, instruction, chatId, humanSchedule: parsed.humanReadable }
     - Return success message with job ID, humanReadable description, and next run time

   **list_crons tool:**
   - Parameters:
     - chatId: z.number().describe("Telegram chat ID")
   - Implementation:
     - Call listCronJobs(chatId)
     - Return JSON array of jobs (id, name, humanSchedule, enabled, nextRunAtMs)
     - Return "No scheduled tasks" if empty

   **delete_cron tool:**
   - Parameters:
     - id: z.string().describe("Job ID (UUID)")
   - Implementation:
     - Call deleteCronJob(id)
     - Return success/not-found message

3. Export all three tools from the file.

CRITICAL: Use the tool() helper from @anthropic-ai/claude-agent-sdk, not manual JSON schema.
  </action>
  <verify>
    - File exists: `ls src/mcp/tools/cron.ts`
    - TypeScript compiles: `npx tsc --noEmit`
    - Exports three tools
  </verify>
  <done>Three cron tools defined with Zod schemas, calling existing cron service functions</done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server and module exports</name>
  <files>
    - src/mcp/server.ts
    - src/mcp/index.ts
  </files>
  <action>
1. Create `src/mcp/server.ts`:
   - Import createSdkMcpServer from @anthropic-ai/claude-agent-sdk
   - Import the three cron tools from './tools/cron.js'
   - Create and export klausbotMcp:
     ```typescript
     export const klausbotMcp = createSdkMcpServer({
       name: "klausbot",
       version: "1.0.0",
       tools: [createCronTool, listCronsTool, deleteCronTool],
     });
     ```

2. Create `src/mcp/index.ts`:
   - Re-export klausbotMcp from './server.js'
   - This is the public API for the MCP module

IMPORTANT: Server name is "klausbot" (no hyphen) - tools will be prefixed `mcp__klausbot__*`
  </action>
  <verify>
    - Files exist: `ls src/mcp/server.ts src/mcp/index.ts`
    - TypeScript compiles: `npx tsc --noEmit`
    - Imports resolve correctly
  </verify>
  <done>MCP server created with cron tools, exported via index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` succeeds
2. Module structure: `ls -la src/mcp/` shows server.ts, index.ts, tools/cron.ts
3. Package.json updated with @anthropic-ai/claude-agent-sdk
</verification>

<success_criteria>
- @anthropic-ai/claude-agent-sdk and @modelcontextprotocol/sdk installed
- src/mcp/tools/cron.ts exports createCronTool, listCronsTool, deleteCronTool
- src/mcp/server.ts exports klausbotMcp using createSdkMcpServer
- src/mcp/index.ts re-exports klausbotMcp
- npm run build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-acp-streaming/05.1-01-SUMMARY.md`
</output>
