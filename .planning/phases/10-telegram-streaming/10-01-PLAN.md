---
phase: 10-telegram-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/schema.ts
  - src/telegram/bot.ts
  - src/telegram/streaming.ts
  - src/telegram/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Streaming config exists with enabled and throttleMs options"
    - "Bot has throttler transformer configured"
    - "Streaming module can spawn Claude with stream-json output"
    - "Streaming module can parse NDJSON events and yield text chunks"
  artifacts:
    - path: "src/telegram/streaming.ts"
      provides: "Claude stream spawner + draft streaming logic"
      exports: ["streamClaudeResponse", "StreamConfig"]
    - path: "src/config/schema.ts"
      provides: "Extended jsonConfigSchema with streaming options"
      contains: "streaming:"
    - path: "src/telegram/bot.ts"
      provides: "Bot with throttler transformer"
      contains: "apiThrottler"
  key_links:
    - from: "src/telegram/streaming.ts"
      to: "child_process.spawn"
      via: "streamClaudeResponse generator"
      pattern: "spawn.*claude.*stream-json"
    - from: "src/telegram/bot.ts"
      to: "@grammyjs/transformer-throttler"
      via: "bot.api.config.use"
      pattern: "apiThrottler"
---

<objective>
Create streaming infrastructure for real-time Claude responses in Telegram.

Purpose: Users will see Claude's response building in real-time via draft messages, providing immediate feedback during generation.

Output:
- `streaming.ts` module with Claude CLI stream spawner
- Config schema extended with streaming options
- Bot configured with throttler transformer
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-telegram-streaming/10-RESEARCH.md

# Existing files to modify
@src/config/schema.ts
@src/telegram/bot.ts
@src/telegram/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install throttler and extend config schema</name>
  <files>package.json, src/config/schema.ts</files>
  <action>
1. Install dependency:
   ```bash
   npm install @grammyjs/transformer-throttler
   ```

2. Extend `jsonConfigSchema` in src/config/schema.ts to add streaming options:
   ```typescript
   export const jsonConfigSchema = z
     .object({
       model: z.string().optional(),
       streaming: z.object({
         enabled: z.boolean().default(true),
         throttleMs: z.number().min(100).max(2000).default(500),
       }).default({ enabled: true, throttleMs: 500 }),
     })
     .strict();
   ```

Keep existing `model` field. The streaming object has two options:
- `enabled`: Toggle streaming on/off (default: true)
- `throttleMs`: Minimum interval between draft updates (default: 500ms)
  </action>
  <verify>
- `npm ls @grammyjs/transformer-throttler` shows installed
- TypeScript compiles: `npm run build`
- Config schema exports JsonConfig type with streaming property
  </verify>
  <done>
- @grammyjs/transformer-throttler installed
- jsonConfigSchema includes streaming.enabled and streaming.throttleMs with defaults
  </done>
</task>

<task type="auto">
  <name>Task 2: Create streaming module with Claude CLI spawner</name>
  <files>src/telegram/streaming.ts</files>
  <action>
Create new file `src/telegram/streaming.ts` with:

1. **StreamConfig interface** matching config schema:
   ```typescript
   export interface StreamConfig {
     enabled: boolean;
     throttleMs: number;
   }
   ```

2. **StreamEvent interface** for NDJSON parsing:
   ```typescript
   interface StreamEvent {
     type: string;
     delta?: { text?: string };
     result?: string;
     cost_usd?: number;
     session_id?: string;
   }
   ```

3. **streamClaudeResponse async generator** that:
   - Spawns `claude` with args: `--dangerously-skip-permissions`, `-p`, prompt, `--output-format`, `stream-json`, `--include-partial-messages`, `--append-system-prompt`, systemPrompt
   - Includes `--mcp-config` and `--settings` (hooks) same as existing spawner
   - Uses `node:readline` createInterface to parse stdout line-by-line
   - Yields text chunks from `content_block_delta` events
   - Returns `{ result: string, cost_usd: number }` at end
   - Wraps prompt in `<user_message>` tags (same security as existing spawner)
   - Supports AbortSignal for cancellation

4. **Helper functions**:
   - Reuse `getMcpConfig()` and `getHooksConfig()` from spawner.ts by either:
     - Exporting them from spawner.ts and importing here, OR
     - Duplicating the logic (simpler, avoids circular deps)

   Prefer duplication to keep streaming.ts self-contained.

Key implementation notes from RESEARCH.md:
- Use `stdio: ['inherit', 'pipe', 'pipe']` to avoid hang bug
- Filter for `event.type === 'content_block_delta' && event.delta?.text`
- Working directory must be KLAUSBOT_HOME
  </action>
  <verify>
- `npm run build` compiles without errors
- File exists at src/telegram/streaming.ts
- Exports StreamConfig and streamClaudeResponse
  </verify>
  <done>
- streaming.ts created with async generator that spawns Claude with stream-json output
- Generator yields text chunks, returns result and cost at completion
- Proper NDJSON parsing via readline
  </done>
</task>

<task type="auto">
  <name>Task 3: Add throttler to bot and export streaming module</name>
  <files>src/telegram/bot.ts, src/telegram/index.ts</files>
  <action>
1. In `src/telegram/bot.ts`, add apiThrottler after autoRetry:
   ```typescript
   import { apiThrottler } from "@grammyjs/transformer-throttler";

   // After autoRetry config
   bot.api.config.use(
     apiThrottler({
       out: {
         maxConcurrent: 1,
         minTime: 100, // Allow faster for drafts, let Telegram reject if needed
       },
     }),
   );
   ```

   Place the throttler AFTER autoRetry so retries happen on rate-limited requests.

2. In `src/telegram/index.ts`, add export:
   ```typescript
   export { streamClaudeResponse, type StreamConfig } from "./streaming.js";
   ```
  </action>
  <verify>
- `npm run build` compiles
- Bot startup still works (no runtime errors)
  </verify>
  <done>
- Bot has apiThrottler transformer configured
- streaming module exported from telegram/index.ts
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Dependencies installed: `npm ls @grammyjs/transformer-throttler`
3. Config schema valid: Import and inspect JsonConfig type
4. Streaming module compiles and exports correctly
</verification>

<success_criteria>
- Streaming infrastructure in place (module, config, throttler)
- Claude CLI stream spawner implemented as async generator
- Config allows enabling/disabling streaming and setting throttle interval
- Ready for gateway integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/10-telegram-streaming/10-01-SUMMARY.md`
</output>
