---
phase: 13-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/logger.ts
  - src/security/redaction.ts
autonomous: true

must_haves:
  truths:
    - "Pairing codes never appear in logs (redacted to [REDACTED])"
    - "API tokens never appear in logs"
    - "Redaction works for both direct and nested paths"
  artifacts:
    - path: "src/security/redaction.ts"
      provides: "Centralized redaction configuration"
      exports: ["REDACT_PATHS", "REDACT_CENSOR"]
    - path: "src/utils/logger.ts"
      provides: "Pino logger with redaction enabled"
      contains: "redact:"
  key_links:
    - from: "src/utils/logger.ts"
      to: "src/security/redaction.ts"
      via: "import redaction config"
      pattern: "from.*security.*redaction"
---

<objective>
Add pino redaction configuration to prevent sensitive data from appearing in logs.

Purpose: Ensure pairing codes, tokens, and other secrets are automatically masked in all log output, addressing the 5 HIGH-risk log statements identified in research.

Output: Logger with redaction enabled, centralized redaction config in security module.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-security-hardening/13-RESEARCH.md
@src/utils/logger.ts
@src/pairing/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create redaction configuration</name>
  <files>src/security/redaction.ts</files>
  <action>
Create `src/security/redaction.ts` with centralized redaction config:

```typescript
/**
 * Pino redaction configuration for sensitive data
 * Used by logger to mask secrets in log output
 *
 * Paths use pino syntax:
 * - 'key' matches { key: 'secret' }
 * - '*.key' matches { obj: { key: 'secret' } }
 */

/** Paths to redact in log output */
export const REDACT_PATHS: string[] = [
  // Pairing codes (most common - 5 log statements in store.ts)
  'code',
  '*.code',
  'result',       // requestPairing returns code as 'result'
  '*.result',

  // API tokens (shouldn't be logged, but safety net)
  'token',
  '*.token',
  'apiKey',
  '*.apiKey',

  // General sensitive field names
  'password',
  '*.password',
  'secret',
  '*.secret',
  'authorization',
  '*.authorization',

  // Environment variable names that might leak
  'TELEGRAM_BOT_TOKEN',
  'OPENAI_API_KEY',
];

/** Replacement text for redacted values */
export const REDACT_CENSOR = '[REDACTED]';
```

Include JSDoc explaining the pino path syntax and why these paths are chosen.
  </action>
  <verify>File exists with exported constants. All 5 pairing log statements from store.ts would be covered by 'code' and '*.code' paths.</verify>
  <done>Redaction config exported with paths covering pairing codes, tokens, and common secrets.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate redaction into logger</name>
  <files>src/utils/logger.ts</files>
  <action>
Modify `src/utils/logger.ts` to use redaction config:

1. Add import at top:
   ```typescript
   import { REDACT_PATHS, REDACT_CENSOR } from '../security/redaction.js';
   ```

2. In `getLogger()` function, add redact config to BOTH pino() calls (TTY and non-TTY branches):
   ```typescript
   _logger = pino(
     {
       level: config.LOG_LEVEL,
       redact: {
         paths: REDACT_PATHS,
         censor: REDACT_CENSOR,
       },
       formatters: { ... },
       timestamp: ...,
     },
     multistream([...])
   );
   ```

3. Similarly update `createMcpLogger()` to use same redaction config.

Preserve all existing functionality (multistream, pino-pretty, etc.). Only ADD redact config to pino options.
  </action>
  <verify>
`npx tsc --noEmit` passes.
Test manually: Log with code field shows [REDACTED]:
```typescript
import { logger } from './src/utils/logger.js';
logger.info({ code: 'ABC123', chatId: 1234 }, 'Test');
// Output should show: { code: '[REDACTED]', chatId: 1234 }
```
  </verify>
  <done>Logger redacts sensitive fields in both TTY and non-TTY modes, plus MCP logger.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. Grep existing log statements to confirm coverage:
   - `src/pairing/store.ts:118` - logs `{ code, chatId }` -> 'code' path covers
   - `src/pairing/store.ts:132` - logs `{ code, chatId }` -> 'code' path covers
   - `src/pairing/store.ts:159` - logs `{ code, chatId }` -> 'code' path covers
   - `src/pairing/store.ts:177` - logs `{ code, chatId }` -> 'code' path covers
   - `src/pairing/flow.ts:65` - logs `{ code: result }` -> 'code' path covers
3. Manual test: Run bot briefly, check logs contain [REDACTED] where codes would appear
</verification>

<success_criteria>
- [ ] src/security/redaction.ts exists with REDACT_PATHS and REDACT_CENSOR exports
- [ ] src/utils/logger.ts imports and applies redaction config
- [ ] Redaction works in TTY mode (pino-pretty)
- [ ] Redaction works in non-TTY mode (JSON)
- [ ] Redaction works in MCP logger
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-security-hardening/13-02-SUMMARY.md`
</output>
