# Phase 13.3 Plan 01: Conversation Context Engine Summary

---

phase: 13.3-infinite-conversation-context
plan: 01
subsystem: memory
tags: [conversation-context, thread-detection, xml-formatting, tiered-history, retrieval-instructions]

requires:

- Phase 7.2 (conversation storage, parseTranscript, extractConversationText)

provides:

- buildConversationContext(chatId) — XML-tagged tiered conversation history
- getConversationsForContext(chatId) — 7-day conversation query
- Thread detection (30min chain walking)
- Search-first retrieval instruction enforcement

affects:

- Plan 13.3-02 (gateway integration — wires buildConversationContext into system prompt)
- Future phases using buildSystemPrompt (conversation history now available)

tech-stack:
added: []
patterns: [tiered-context-budgeting, time-proximity-thread-detection, xml-tagged-history-injection]

key-files:
created: []
modified: [src/memory/conversations.ts, src/memory/context.ts, src/memory/index.ts]

key-decisions:

- Character-based budget (120K chars ~ 30K tokens) not tokenizer library
- Thread detection walks backward through 30min gaps (not fixed window)
- Calendar-day comparison for relative time labels (not timestamp math)
- Tier 1/2 get full transcripts; Tier 3/4 get summaries only

duration: 2m 46s
completed: 2026-02-06

---

**One-liner:** Tiered conversation context engine with 30min-chain thread detection, XML formatting, 120K char budget, and search-first retrieval enforcement.

## Performance

- Duration: 2m 46s
- No blockers, no new dependencies
- Both tasks executed as planned with zero deviations

## Accomplishments

1. **Conversation query layer** (`getConversationsForContext`): Queries last 7 days of conversations by chatId using existing drizzle patterns. No limit — returns all for context builder to budget.

2. **Thread detection** (`detectActiveThread`): Walks backward from most recent conversation, including any within 30min of each other in the active thread chain. Returns `isContinuation` flag and set of thread session IDs.

3. **Tiered context builder** (`buildConversationContext`): Four-tier formatting system:
   - Tier 1 (FULL): Active thread conversations (30min chain)
   - Tier 2 (FULL): Today's other conversations
   - Tier 3 (SUMMARY): Yesterday's conversations
   - Tier 4 (SUMMARY): Older (2-7 days)
     Priority-based budget enforcement: adds conversations in tier order, stops at 120K chars.

4. **XML output format**: `<conversation-history>` wrapping `<thread-status>` + `<conversation>` tags with timestamps, relative time labels, and `[human HH:MM]`/`[you HH:MM]` message formatting.

5. **Retrieval instruction rewrite**: Replaced passive "When in doubt, search" with assertive "MANDATORY: Search Before Claiming Ignorance" section including explicit FAILURE/CORRECT behavior examples.

## Task Commits

| Task | Name                                                   | Commit    | Files                                                                   |
| ---- | ------------------------------------------------------ | --------- | ----------------------------------------------------------------------- |
| 1    | Conversation query layer + context builder + threading | `b8f98dc` | src/memory/conversations.ts, src/memory/context.ts, src/memory/index.ts |
| 2    | Rewrite retrieval instructions                         | `d1c4776` | src/memory/context.ts                                                   |

## Files Modified

- **src/memory/conversations.ts**: Added `getConversationsForContext()` function
- **src/memory/context.ts**: Added imports, constants (`ACTIVE_THREAD_WINDOW_MS`, `TODAY_WINDOW_MS`, `MAX_CONTEXT_CHARS`), helper functions (`getRelativeTimeLabel`, `extractEntryText`, `formatFullTranscript`, `formatSummaryXml`, `detectActiveThread`), `buildConversationContext()`, and rewrote retrieval instructions
- **src/memory/index.ts**: Added exports for `buildConversationContext` and `getConversationsForContext`

## Decisions Made

| Decision                         | Rationale                                                                      |
| -------------------------------- | ------------------------------------------------------------------------------ |
| 120K char budget (not tokenizer) | No official local tokenizer for Claude 3+; 4:1 ratio standard                  |
| Walk-backward thread detection   | Chains conversations within 30min of each other, not fixed window from now     |
| Calendar-day relative labels     | "today"/"yesterday"/day-name avoids timezone edge cases with timestamp math    |
| Filter user+assistant types only | Skips tool_use/system entries that bloat transcripts (Pitfall 6 from research) |
| Tier 1 reversed to chronological | Reading order: oldest first within active thread                               |

## Deviations from Plan

None — plan executed exactly as written.

## Issues Encountered

None.

## Next Phase Readiness

Plan 13.3-02 can proceed immediately. It needs to:

1. Wire `buildConversationContext(chatId)` into `buildSystemPrompt()` or gateway's `additionalInstructions`
2. Simplify SessionStart hook (remove summary injection, now in system prompt)
3. Thread `chatId` through spawner/streaming paths to `buildSystemPrompt()`

All exports are in place. No blockers.
