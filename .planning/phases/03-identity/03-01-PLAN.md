---
phase: 03-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bootstrap/detector.ts
  - src/bootstrap/prompts.ts
  - src/bootstrap/index.ts
  - src/memory/context.ts
  - src/memory/index.ts
autonomous: true

must_haves:
  truths:
    - "needsBootstrap() returns true when any identity file missing"
    - "needsBootstrap() returns false when all identity files exist"
    - "BOOTSTRAP_SYSTEM_PROMPT contains conversational interview flow"
    - "invalidateIdentityCache() forces reload on next loadIdentity()"
  artifacts:
    - path: "src/bootstrap/detector.ts"
      provides: "needsBootstrap(), getBootstrapState()"
      exports: ["needsBootstrap", "getBootstrapState"]
    - path: "src/bootstrap/prompts.ts"
      provides: "Bootstrap system prompt for conversational identity creation"
      exports: ["BOOTSTRAP_SYSTEM_PROMPT"]
    - path: "src/bootstrap/index.ts"
      provides: "Re-exports from bootstrap module"
      exports: ["needsBootstrap", "getBootstrapState", "BOOTSTRAP_SYSTEM_PROMPT"]
    - path: "src/memory/context.ts"
      provides: "Identity cache invalidation function"
      exports: ["invalidateIdentityCache"]
  key_links:
    - from: "src/bootstrap/detector.ts"
      to: "src/memory/home.ts"
      via: "getHomePath import"
      pattern: "import.*getHomePath.*from.*memory"
---

<objective>
Create bootstrap detection and cache invalidation foundation for identity system.

Purpose: Enable gateway to detect when bootstrap is needed (first-time user) and allow instant identity updates without process restart.
Output: Bootstrap module (detector + prompts) and cache invalidation in memory module.
</objective>

<execution_context>
@/home/soham/.claude/get-shit-done/workflows/execute-plan.md
@/home/soham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-identity/03-CONTEXT.md
@.planning/phases/03-identity/03-RESEARCH.md

# Key prior work
@src/memory/context.ts
@src/memory/identity.ts
@src/memory/home.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bootstrap detector module</name>
  <files>src/bootstrap/detector.ts, src/bootstrap/index.ts</files>
  <action>
Create src/bootstrap/detector.ts with:

1. Import existsSync from fs and getHomePath from memory
2. Define REQUIRED_FILES constant: ['SOUL.md', 'IDENTITY.md', 'USER.md']
3. Implement needsBootstrap():
   - Loop through REQUIRED_FILES
   - For each, check existsSync(getHomePath('identity', file))
   - Return true if ANY file missing, false if ALL exist
4. Implement getBootstrapState():
   - Return 'needed' | 'complete' based on needsBootstrap()

Create src/bootstrap/index.ts with re-exports:
- Export { needsBootstrap, getBootstrapState } from './detector.js'
- Export { BOOTSTRAP_SYSTEM_PROMPT } from './prompts.js' (will exist after Task 2)

Note: REMINDERS.md is NOT in REQUIRED_FILES - it's optional, not part of core identity.
  </action>
  <verify>
npx tsc --noEmit && echo "TypeScript compiles"
Test manually: node -e "import('./dist/bootstrap/index.js').then(m => console.log(m.needsBootstrap()))"
  </verify>
  <done>
needsBootstrap() returns boolean based on identity file existence.
getBootstrapState() returns 'needed' or 'complete'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bootstrap system prompt</name>
  <files>src/bootstrap/prompts.ts</files>
  <action>
Create src/bootstrap/prompts.ts with BOOTSTRAP_SYSTEM_PROMPT constant.

The prompt should:
1. Explain Claude is in BOOTSTRAP mode (first-time setup)
2. Guide conversational interview (feel like making a friend, not a form):
   - Ask name for bot
   - Ask communication style (formal/casual, brief/detailed)
   - Ask about user (name, timezone, preferences)
3. Specify file creation format:
   - SOUL.md: Core values, principles, boundaries (locked after creation)
   - IDENTITY.md: Name, style, personality (user-modifiable)
   - USER.md: User name, preferences, context (auto-updated)
4. Include file path: ~/.klausbot/identity/{file}
5. State: 3-5 exchanges max, then create files
6. After file creation: confirm identity with personality, switch to normal mode

Include boundary defaults:
- "I don't pretend to be other AIs"
- "I deflect with personality: 'That's not really my thing, but...'"

See 03-RESEARCH.md Pattern 2 for full prompt structure.
  </action>
  <verify>
npx tsc --noEmit && echo "TypeScript compiles"
grep -q "BOOTSTRAP_SYSTEM_PROMPT" src/bootstrap/prompts.ts
  </verify>
  <done>
BOOTSTRAP_SYSTEM_PROMPT exported with conversational interview flow.
Prompt includes file creation instructions and boundary defaults.
  </done>
</task>

<task type="auto">
  <name>Task 3: Identity cache invalidation</name>
  <files>src/memory/context.ts, src/memory/index.ts</files>
  <action>
Modify src/memory/context.ts:

1. Add invalidateIdentityCache() function:
   - Sets identityCache = null
   - Next loadIdentity() call will reload from disk

2. Add reloadIdentity() convenience function (optional):
   - Calls invalidateIdentityCache()
   - Calls and returns loadIdentity()

Update src/memory/index.ts:
- Add invalidateIdentityCache to exports from context.ts

This enables instant identity updates without process restart.
Per 03-RESEARCH.md: "Start with approach #1 (invalidate every time) - identity files are small, re-reading is cheap."
  </action>
  <verify>
npx tsc --noEmit && echo "TypeScript compiles"
grep -q "invalidateIdentityCache" src/memory/context.ts
grep -q "invalidateIdentityCache" src/memory/index.ts
  </verify>
  <done>
invalidateIdentityCache() exported from memory module.
Calling it clears cache, forcing reload on next loadIdentity().
  </done>
</task>

</tasks>

<verification>
- npm run build succeeds
- All three functions exported and callable
- Bootstrap detector correctly identifies missing identity files
</verification>

<success_criteria>
1. src/bootstrap/ module exists with detector.ts, prompts.ts, index.ts
2. needsBootstrap() returns true when identity files missing
3. BOOTSTRAP_SYSTEM_PROMPT contains conversational interview flow
4. invalidateIdentityCache() clears identity cache
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-identity/03-01-SUMMARY.md`
</output>
